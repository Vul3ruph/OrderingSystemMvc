@model List<OrderingSystemMvc.Models.Order>
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}
@{
    ViewData["Title"] = "訂單管理";
    var statusOptions = ViewBag.StatusOptions as List<OrderingSystemMvc.Models.OrderStatus>;
}

<div class="container-fluid py-4">
    <!-- 統計卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                總訂單數
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-receipt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                今日訂單
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TodayOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                待處理訂單
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.PendingOrders</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                今日營收
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">$@ViewBag.TodayRevenue</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋和篩選 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter me-2"></i>搜尋與篩選
            </h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">狀態</label>
                        <select name="status" class="form-select">
                            <option value="">全部狀態</option>
                            @if (statusOptions != null)
                            {
                                @foreach (var status in statusOptions)
                                {
                                    <option value="@status.Code" selected="@(ViewBag.CurrentStatus == status.Code)">
                                        @status.Name
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">搜尋關鍵字</label>
                        <input type="text" name="searchTerm" class="form-control"
                               placeholder="訂單編號或商品名稱" value="@ViewBag.SearchTerm" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">開始日期</label>
                        <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">結束日期</label>
                        <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>搜尋
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 訂單列表 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list me-2"></i>訂單列表 (@Model.Count 筆)
            </h6>
            <div>
                <button class="btn btn-success btn-sm me-2" onclick="autoRefresh()">
                    <i class="fas fa-sync-alt me-1"></i>自動刷新
                </button>
                <button class="btn btn-info btn-sm" onclick="exportOrders()">
                    <i class="fas fa-download me-1"></i>匯出
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">沒有找到訂單</h5>
                    <p class="text-muted">請調整搜尋條件或等待新訂單</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="8%">訂單編號</th>
                                <th width="15%">建立時間</th>
                                <th width="12%">狀態</th>
                                <th width="25%">商品摘要</th>
                                <th width="10%">數量</th>
                                <th width="12%">總金額</th>
                                <th width="10%">客戶</th>
                                <th width="8%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr id="order-row-@order.Id">
                                    <td class="fw-bold text-primary">#@order.Id</td>
                                    <td>
                                        <div>@order.CreatedAt.ToString("yyyy/MM/dd")</div>
                                        <small class="text-muted">@order.CreatedAt.ToString("HH:mm:ss")</small>
                                    </td>
                                    <td>
                                        <span id="status-badge-@order.Id" class="badge bg-@GetStatusColor(order.Status?.Code)">
                                            @(order.Status?.Name ?? "未知")
                                        </span>
                                    </td>
                                    <td>
                                        <div class="small">
                                            @foreach (var item in order.Items.Take(2))
                                            {
                                                <div>@item.Name x@item.Quantity</div>
                                            }
                                            @if (order.Items.Count > 2)
                                            {
                                                <div class="text-muted">等 @order.Items.Count 項商品</div>
                                            }
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">@order.Items.Sum(i => i.Quantity)</span>
                                    </td>
                                    <td class="fw-bold text-success">$@order.TotalAmount</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(order.UserId))
                                        {
                                            <i class="fas fa-user text-success"></i>
                                            <span class="small">會員</span>
                                        }
                                        else
                                        {
                                            <i class="fas fa-user-times text-muted"></i>
                                            <span class="small text-muted">訪客</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <a href="@Url.Action("Details", new { id = order.Id })"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-warning btn-sm dropdown-toggle"
                                                        type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    @if (statusOptions != null)
                                                    {
                                                        @foreach (var status in statusOptions)
                                                        {
                                                            <li>
                                                                <a class="dropdown-item" href="#"
                                                                   onclick="updateStatus(@order.Id, @status.Id, '@status.Name', '@status.Code')">
                                                                    @status.Name
                                                                </a>
                                                            </li>
                                                        }
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    string GetStatusColor(string? statusCode)
    {
        return statusCode switch
        {
            "PENDING" => "warning",
            "CONFIRMED" => "info",
            "PREPARING" => "primary",
            "READY" => "success",
            "DELIVERED" => "success",
            "CANCELLED" => "danger",
            "REFUNDED" => "secondary",
            _ => "secondary"
        };
    }
}

<!-- 加入 AntiForgeryToken -->
@Html.AntiForgeryToken()

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 更新訂單狀態
        function updateStatus(orderId, statusId, statusName, statusCode) {
            Swal.fire({
                title: '確認更新狀態',
                text: `確定要將訂單 #${orderId} 的狀態更新為「${statusName}」嗎？`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '確定更新',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 顯示載入中
                    Swal.fire({
                        title: '更新中...',
                        text: '請稍候',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // 發送 AJAX 請求
                    $.ajax({
                        url: '@Url.Action("UpdateStatus")',
                        type: 'POST',
                        data: {
                            id: orderId,
                            statusId: statusId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            console.log('更新成功回應:', response);

                            if (response.success) {
                                // 更新狀態徽章
                                const statusBadge = $(`#status-badge-${orderId}`);
                                statusBadge.text(statusName);
                                statusBadge.removeClass().addClass(`badge bg-${getStatusColor(statusCode)}`);

                                // 顯示成功訊息
                                Swal.fire({
                                    icon: 'success',
                                    title: '更新成功！',
                                    text: response.message || `訂單狀態已更新為「${statusName}」`,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '更新失敗',
                                    text: response.message || '更新訂單狀態失敗'
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX 錯誤:', {
                                status: status,
                                error: error,
                                responseText: xhr.responseText
                            });

                            Swal.fire({
                                icon: 'error',
                                title: '系統錯誤',
                                text: '更新失敗，請稍後再試或聯絡管理員'
                            });
                        }
                    });
                }
            });
        }

        // 取得狀態對應的顏色
        function getStatusColor(statusCode) {
            const colorMap = {
                'PENDING': 'warning',
                'CONFIRMED': 'info',
                'PREPARING': 'primary',
                'READY': 'success',
                'DELIVERED': 'success',
                'CANCELLED': 'danger',
                'REFUNDED': 'secondary'
            };
            return colorMap[statusCode] || 'secondary';
        }

        // 自動刷新
        let autoRefreshInterval;
        function autoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                $('button[onclick="autoRefresh()"]').html('<i class="fas fa-sync-alt me-1"></i>自動刷新');

                Swal.fire({
                    icon: 'info',
                    title: '自動刷新已停止',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                autoRefreshInterval = setInterval(function() {
                    location.reload();
                }, 30000);
                $('button[onclick="autoRefresh()"]').html('<i class="fas fa-stop me-1"></i>停止刷新');

                Swal.fire({
                    icon: 'success',
                    title: '自動刷新已開啟',
                    text: '每30秒自動更新一次',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        // 匯出訂單
        function exportOrders() {
            const currentUrl = new URL(window.location);
            currentUrl.pathname = '@Url.Action("Export")';
            window.open(currentUrl.toString(), '_blank');
        }

        $(document).ready(function() {
            // 初始化 tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            console.log('頁面已載入，準備處理狀態更新');
        });
    </script>
}