@model OrderingSystemMvc.Models.Order
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}
@{
    ViewData["Title"] = $"訂單 #{Model.Id} 詳細資訊";
    var statusOptions = ViewBag.StatusOptions as List<OrderingSystemMvc.Models.OrderStatus>;
}

<div class="container-fluid py-4">
    <!-- 頁面標題和操作 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-receipt text-primary me-2"></i>
                訂單 #@Model.Id 詳細資訊
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-area="Admin" asp-controller="Home" asp-action="Index">管理後台</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-area="Admin" asp-controller="Order" asp-action="Index">訂單管理</a>
                    </li>
                    <li class="breadcrumb-item active">訂單詳細</li>
                </ol>
            </nav>
        </div>
        <div>
            <a asp-area="Admin" asp-controller="Order" asp-action="Index" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i>返回列表
            </a>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>列印
            </button>
        </div>
    </div>

    <div class="row">
        <!-- 左側：訂單基本資訊 -->
        <div class="col-xl-8">
            <!-- 訂單狀態卡片 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>訂單狀態
                    </h6>
                    <span class="badge bg-@GetStatusColor(Model.Status?.Code) fs-6">
                        @(Model.Status?.Name ?? "未知")
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td width="30%"><strong>訂單編號：</strong></td>
                                    <td>#@Model.Id</td>
                                </tr>
                                <tr>
                                    <td><strong>建立時間：</strong></td>
                                    <td>@Model.CreatedAt.ToString("yyyy年MM月dd日 HH:mm:ss")</td>
                                </tr>
                                <tr>
                                    <td><strong>總金額：</strong></td>
                                    <td class="text-success fw-bold fs-5">$@Model.TotalAmount</td>
                                </tr>
                                <tr>
                                    <td><strong>商品數量：</strong></td>
                                    <td>@Model.Items.Sum(i => i.Quantity) 項</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td width="30%"><strong>客戶類型：</strong></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(Model.UserId))
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-user me-1"></i>會員
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-user-times me-1"></i>訪客
                                            </span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>付款方式：</strong></td>
                                    <td>
                                        <i class="fas fa-money-bill-wave text-success me-1"></i>
                                        現金付款
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>取餐方式：</strong></td>
                                    <td>
                                        <i class="fas fa-store text-primary me-1"></i>
                                        店內取餐
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>處理時間：</strong></td>
                                    <td>
                                        @{
                                            var processingTime = DateTime.Now - Model.CreatedAt;
                                        }
                                        @((int)processingTime.TotalMinutes) 分鐘
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 訂單商品明細 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-shopping-bag me-2"></i>訂單商品明細
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="45%">商品資訊</th>
                                    <th width="12%" class="text-center">單價</th>
                                    <th width="8%" class="text-center">數量</th>
                                    <th width="15%" class="text-center">加購選項</th>
                                    <th width="15%" class="text-end">小計</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{var itemIndex = 1;}
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td class="align-middle text-center">@itemIndex</td>
                                        <td class="align-middle">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <img src="@(item.MenuItem?.ImageUrl ?? "https://via.placeholder.com/60x60")" 
                                                         alt="@item.Name" class="rounded border" 
                                                         style="width: 60px; height: 60px; object-fit: cover;" />
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">@item.Name</h6>
                                                    @if (!string.IsNullOrEmpty(item.MenuItem?.Description))
                                                    {
                                                        <p class="small text-muted mb-0">@item.MenuItem.Description</p>
                                                    }
                                                    <div class="small">
                                                        <span class="badge bg-info">分類ID: @(item.MenuItem?.CategoryId ?? 0)</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="align-middle text-center">
                                            <span class="fw-bold text-primary">$@item.Price</span>
                                        </td>
                                        <td class="align-middle text-center">
                                            <span class="badge bg-dark fs-6">@item.Quantity</span>
                                        </td>
                                        <td class="align-middle text-center">
                                            @if (item.OrderOptionItems?.Any() == true)
                                            {
                                                <div class="small">
                                                    @foreach (var option in item.OrderOptionItems)
                                                    {
                                                        <div class="mb-1">
                                                            <span class="badge bg-warning text-dark">
                                                                @(option.OptionItem?.Name ?? "選項")
                                                            </span>
                                                            @if (option.ExtraPrice > 0)
                                                            {
                                                                <br><small class="text-success">+$@option.ExtraPrice</small>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted small">無加購</span>
                                            }
                                        </td>
                                        <td class="align-middle text-end">
                                            @{
                                                var extraPrice = item.OrderOptionItems?.Sum(o => o.ExtraPrice * item.Quantity) ?? 0;
                                                var itemTotal = (item.Price * item.Quantity) + extraPrice;
                                            }
                                            <div class="fw-bold text-success fs-6">$@itemTotal</div>
                                            @if (extraPrice > 0)
                                            {
                                                <small class="text-muted">
                                                    基本: $@(item.Price * item.Quantity)<br>
                                                    加購: $@extraPrice
                                                </small>
                                            }
                                        </td>
                                    </tr>
                                    itemIndex++;
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">商品總計：</td>
                                    <td class="text-end fw-bold text-success fs-5">$@Model.TotalAmount</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側：操作面板 -->
        <div class="col-xl-4">
            <!-- 狀態管理 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cogs me-2"></i>狀態管理
                    </h6>
                </div>
                <div class="card-body">
                    <form id="statusUpdateForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">當前狀態</label>
                            <div>
                                <span class="badge bg-@GetStatusColor(Model.Status?.Code) fs-6">
                                    <i class="@GetStatusIcon(Model.Status?.Code) me-1"></i>
                                    @(Model.Status?.Name ?? "未知")
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newStatus" class="form-label fw-bold">更新狀態</label>
                            <select id="newStatus" class="form-select">
                                <option value="">選擇新狀態...</option>
                                @if (statusOptions != null)
                                {
                                    @foreach (var status in statusOptions)
                                    {
                                        @if (status.Id == Model.OrderStatusId)
                                        {
                                            <option value="@status.Id" data-code="@status.Code" disabled>
                                                @status.Name (目前)
                                            </option>
                                        }
                                        else
                                        {
                                            <option value="@status.Id" data-code="@status.Code">
                                                @status.Name
                                            </option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">
                                <i class="fas fa-save me-1"></i>更新狀態
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 快速動作 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt me-2"></i>快速動作
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (statusOptions != null)
                        {
                            @foreach (var status in statusOptions.Where(s => s.Id != Model.OrderStatusId))
                            {
                                <button class="btn btn-outline-@GetStatusColor(status.Code) btn-sm" 
                                        onclick="quickUpdateStatus(@status.Id, '@status.Name', '@status.Code')">
                                    <i class="@GetStatusIcon(status.Code) me-1"></i>
                                    設為 @status.Name
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- 訂單統計 -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar me-2"></i>訂單統計
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">商品種類</small>
                        <div class="fw-bold">@Model.Items.Count 種</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">商品總數</small>
                        <div class="fw-bold">@Model.Items.Sum(i => i.Quantity) 件</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">基本金額</small>
                        <div class="fw-bold">$@Model.Items.Sum(i => i.Price * i.Quantity)</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">加購金額</small>
                        <div class="fw-bold text-warning">$@Model.Items.SelectMany(i => i.OrderOptionItems).Sum(o => o.ExtraPrice)</div>
                    </div>
                    <hr>
                    <div>
                        <small class="text-muted">訂單總額</small>
                        <div class="fw-bold text-success fs-5">$@Model.TotalAmount</div>
                    </div>
                </div>
            </div>

            
        </div>
    </div>
</div>

@functions {
    string GetStatusColor(string? statusCode)
    {
        return statusCode switch
        {
            "PENDING" => "warning",
            "CONFIRMED" => "info",
            "PREPARING" => "primary",
            "READY" => "success",
            "DELIVERED" => "success",
            "CANCELLED" => "danger",
            "REFUNDED" => "secondary",
            _ => "secondary"
        };
    }
    
    string GetStatusIcon(string? statusCode)
    {
        return statusCode switch
        {
            "PENDING" => "fas fa-clock",
            "CONFIRMED" => "fas fa-check",
            "PREPARING" => "fas fa-utensils",
            "READY" => "fas fa-bell",
            "DELIVERED" => "fas fa-check-circle",
            "CANCELLED" => "fas fa-times-circle",
            "REFUNDED" => "fas fa-undo",
            _ => "fas fa-question"
        };
    }
}

<!-- 加入 AntiForgeryToken -->
@Html.AntiForgeryToken()

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 更新訂單狀態
        function updateOrderStatus() {
            const statusSelect = document.getElementById('newStatus');
            const statusId = statusSelect.value;
            const statusName = statusSelect.options[statusSelect.selectedIndex].text;
            
            if (!statusId) {
                Swal.fire('提示', '請選擇要更新的狀態', 'warning');
                return;
            }
            
            quickUpdateStatus(statusId, statusName.replace(' (目前)', ''));
        }

        // 快速更新狀態
        function quickUpdateStatus(statusId, statusName, statusCode = '') {
            Swal.fire({
                title: '確認更新狀態',
                text: `確定要將訂單 #@Model.Id 的狀態更新為「${statusName}」嗎？`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '確定更新',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 顯示載入中
                    Swal.fire({
                        title: '更新中...',
                        text: '請稍候',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // 發送 AJAX 請求
                    $.ajax({
                        url: '@Url.Action("UpdateStatus")',
                        type: 'POST',
                        data: {
                            id: @Model.Id,
                            statusId: statusId,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '更新成功！',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    // 重新載入頁面以顯示最新狀態
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '更新失敗',
                                    text: response.message
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX 錯誤:', error);
                            Swal.fire({
                                icon: 'error',
                                title: '系統錯誤',
                                text: '更新失敗，請稍後再試'
                            });
                        }
                    });
                }
            });
        }

        // 刪除訂單
        function deleteOrder() {
            Swal.fire({
                title: '危險操作！',
                text: '確定要刪除訂單 #@Model.Id 嗎？此操作無法復原！',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '確定刪除',
                cancelButtonText: '取消',
                input: 'text',
                inputPlaceholder: '請輸入 "DELETE" 確認刪除',
                inputValidator: (value) => {
                    if (value !== 'DELETE') {
                        return '請正確輸入 "DELETE" 確認刪除操作'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Delete")',
                        type: 'POST',
                        data: {
                            id: @Model.Id,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: '刪除成功',
                                text: '訂單已成功刪除',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = '@Url.Action("Index")';
                            });
                        },
                        error: function() {
                            Swal.fire({
                                icon: 'error',
                                title: '刪除失敗',
                                text: '無法刪除訂單，請稍後再試'
                            });
                        }
                    });
                }
            });
        }

        $(document).ready(function() {
            // 初始化工具提示
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}

