@model List<Category>
@{
    ViewData["Title"] = "分類管理";
}
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- 頁面標題和操作區 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">
                <i class="fas fa-tags me-2"></i>分類管理
            </h2>
            <p class="text-muted mb-0">管理餐點分類，調整顯示順序</p>
        </div>
        <div>
            <button class="btn btn-primary btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus me-2"></i>新增分類
            </button>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-layer-group fa-2x opacity-75"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fs-6 fw-semibold">總分類數</div>
                            <div class="fs-4 fw-bold">@Model.Count</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-utensils fa-2x opacity-75"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fs-6 fw-semibold">總商品數</div>
                            <div class="fs-4 fw-bold">@Model.Sum(c => c.MenuItems?.Count ?? 0)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-sort-numeric-down fa-2x opacity-75"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fs-6 fw-semibold">排序範圍</div>
                            <div class="fs-4 fw-bold">1-@Model.Count</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fs-6 fw-semibold">系統分類</div>
                            <div class="fs-4 fw-bold">@Model.Count(c => c.Id == 0)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分類列表 -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light border-0">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0 fw-semibold">
                        <i class="fas fa-list me-2 text-primary"></i>分類列表
                    </h5>
                </div>
                <div class="col-auto">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" placeholder="搜尋分類名稱..." id="searchInput">
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="categoryTable">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 ps-4" width="5%">
                                <i class="fas fa-grip-vertical text-muted"></i>
                            </th>
                            <th class="border-0" width="35%">
                                <i class="fas fa-tag me-2 text-primary"></i>分類名稱
                            </th>
                            <th class="border-0 text-center" width="15%">
                                <i class="fas fa-sort-numeric-down me-2 text-info"></i>排序
                            </th>
                            <th class="border-0 text-center" width="15%">
                                <i class="fas fa-utensils me-2 text-warning"></i>商品數量
                            </th>
                            <th class="border-0 text-center" width="15%">
                                <i class="fas fa-info-circle me-2 text-success"></i>類型
                            </th>
                            <th class="border-0 text-center pe-4" width="15%">
                                <i class="fas fa-cogs me-2 text-secondary"></i>操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="sortable-categories">
                        @foreach (var category in Model.OrderBy(c => c.SortOrder))
                        {
                            <tr class="category-row @(category.Id == 0 ? "table-warning" : "")" data-id="@category.Id">
                                <td class="ps-4 align-middle">
                                    @if (category.Id != 0)
                                    {
                                        <i class="fas fa-grip-vertical text-muted sortable-handle" style="cursor: move;"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-lock text-warning" title="系統分類，無法移動"></i>
                                    }
                                </td>
                                <td class="align-middle">
                                    <div class="d-flex align-items-center">
                                        <div class="category-icon me-3">
                                            <div class="rounded-circle @(category.Id == 0 ? "bg-warning-subtle" : "bg-primary-subtle") d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas @(category.Id == 0 ? "fa-archive text-warning" : "fa-utensils text-primary")"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">
                                                @category.Name
                                                @if (category.Id == 0)
                                                {
                                                    <span class="badge bg-warning-subtle text-warning ms-2">
                                                        <i class="fas fa-shield-alt me-1"></i>系統預設
                                                    </span>
                                                }
                                            </div>
                                            <small class="text-muted">ID: @category.Id</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge bg-light text-dark border fs-6 px-3 py-2">
                                        @category.SortOrder
                                    </span>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge bg-warning-subtle text-warning border-warning fs-6 px-3 py-2">
                                        @(category.MenuItems?.Count ?? 0) 項
                                    </span>
                                </td>
                                <td class="text-center align-middle">
                                    @if (category.Id == 0)
                                    {
                                        <span class="badge bg-warning-subtle text-warning border-warning fs-6 px-3 py-2">
                                            <i class="fas fa-shield-alt me-1"></i>系統
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success-subtle text-success border-success fs-6 px-3 py-2">
                                            <i class="fas fa-user me-1"></i>自訂
                                        </span>
                                    }
                                </td>
                                <td class="text-center align-middle pe-4">
                                    @if (category.Id != 0)
                                    {
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                                                    onclick="editCategory(@category.Id, '@category.Name', @category.SortOrder)"
                                                    data-bs-toggle="tooltip" title="編輯">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="showDeleteConfirm(@category.Id, '@category.Name', @(category.MenuItems?.Count ?? 0))"
                                                    data-bs-toggle="tooltip" title="刪除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">
                                            <i class="fas fa-lock me-1"></i>系統保護
                                        </span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 新增分類 Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>新增分類
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Upsert" method="post">
                <input type="hidden" name="Id" value="0" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-tag me-2 text-primary"></i>分類名稱
                        </label>
                        <input type="text" name="Name" class="form-control form-control-lg"
                               placeholder="請輸入分類名稱" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-sort-numeric-down me-2 text-info"></i>排序順序
                        </label>
                        <input type="number" name="SortOrder" class="form-control form-control-lg"
                               value="0" placeholder="留空自動分配">
                        <div class="form-text">數字越小越前面顯示，留空會自動分配到最後</div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>新增分類
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 編輯分類 Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>編輯分類
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="Upsert" method="post" id="editCategoryForm">
                <input type="hidden" name="Id" id="editCategoryId">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-tag me-2 text-primary"></i>分類名稱
                        </label>
                        <input type="text" name="Name" id="editCategoryName" class="form-control form-control-lg" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-sort-numeric-down me-2 text-info"></i>排序順序
                        </label>
                        <input type="number" name="SortOrder" id="editCategorySortOrder" class="form-control form-control-lg" required>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save me-2"></i>儲存變更
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-body text-center p-4">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light"
                         style="width: 80px; height: 80px; border: 3px solid #17a2b8;">
                        <i class="fas fa-question text-info" style="font-size: 2rem;"></i>
                    </div>
                </div>

                <h5 class="fw-bold text-dark mb-3">確認刪除分類</h5>

                <p class="text-muted mb-4" id="deleteConfirmText">
                    確定要刪除分類「分類名稱」嗎？
                </p>

                <div class="d-flex gap-3 justify-content-center">
                    <button type="button" class="btn btn-info px-4 fw-semibold"
                            style="border-radius: 25px; min-width: 80px;"
                            id="confirmDeleteBtn">
                        確定刪除
                    </button>
                    <button type="button" class="btn btn-danger px-4 fw-semibold"
                            style="border-radius: 25px; min-width: 80px;"
                            data-bs-dismiss="modal">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 自定義樣式 */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }

    .sortable-handle {
        transition: color 0.2s ease;
    }

        .sortable-handle:hover {
            color: #007bff !important;
            transform: scale(1.2);
        }

    .category-icon {
        transition: transform 0.2s ease;
    }

    .category-row:hover .category-icon {
        transform: scale(1.1);
    }

    .btn-group .btn {
        border-radius: 0.375rem;
        margin: 0 2px;
    }

    .modal-content {
        border-radius: 1rem;
    }

    .badge {
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* 搜尋框樣式 */
    .input-group .form-control:focus {
        z-index: 3;
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* 響應式調整 */
    @@media (max-width: 768px) {
        .btn-group

    {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .btn-group .btn {
        margin: 0;
        border-radius: 0.375rem;
    }

    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    // 初始化排序功能
    document.addEventListener('DOMContentLoaded', function() {
        const sortable = new Sortable(document.getElementById('sortable-categories'), {
            handle: '.sortable-handle',
            animation: 150,
            ghostClass: 'table-active',
            filter: '.table-warning', // 排除系統分類
            onEnd: function(evt) {
                updateSortOrder();
            }
        });

        // 初始化 tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // 搜尋功能
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#categoryTable tbody tr');

            rows.forEach(function(row) {
                const categoryName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                if (categoryName.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // 編輯分類
    function editCategory(id, name, sortOrder) {
        document.getElementById('editCategoryId').value = id;
        document.getElementById('editCategoryName').value = name;
        document.getElementById('editCategorySortOrder').value = sortOrder;
    }

    // 顯示刪除確認對話框
    function showDeleteConfirm(categoryId, categoryName, itemCount) {
        const confirmText = document.getElementById('deleteConfirmText');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        let message = `確定要刪除分類「${categoryName}」嗎？`;
        if (itemCount > 0) {
            message += `\n此分類包含 ${itemCount} 個商品，刪除後這些商品將移至「未分類」。`;
        }

        confirmText.textContent = message;

        // 設置確認按鈕點擊事件
        confirmBtn.onclick = function() {
            // 創建表單提交刪除請求
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Admin/Category/Delete';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = categoryId;
            form.appendChild(idInput);

            // 添加防偽Token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        };

        // 顯示Modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    // 更新排序順序
    function updateSortOrder() {
        const rows = document.querySelectorAll('#sortable-categories tr:not(.table-warning)');
        const updates = [];

        rows.forEach((row, index) => {
            const id = row.getAttribute('data-id');
            if (id != 0) { // 排除系統分類
                updates.push({
                    id: id,
                    sortOrder: index + 1
                });
            }
        });

        // 發送 AJAX 更新排序
        fetch('/Admin/Category/UpdateSortOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify(updates)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新顯示的排序數字
                rows.forEach((row, index) => {
                    const sortBadge = row.querySelector('td:nth-child(3) .badge');
                    if (row.getAttribute('data-id') != 0) {
                        sortBadge.textContent = index + 1;
                    }
                });

                // 顯示成功訊息
                showToast('排序已更新', 'success');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('更新排序失敗', 'error');
        });
    }

    // 顯示提示訊息
    function showToast(message, type) {
        // 這裡可以整合你現有的通知系統
        console.log(`${type}: ${message}`);
    }
</script>