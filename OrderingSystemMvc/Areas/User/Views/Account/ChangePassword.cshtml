@model OrderingSystemMvc.ViewModels.ChangePasswordViewModel
@{
    ViewData["Title"] = "修改密碼";
}

<div class="container py-4">
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-key me-2"></i>修改密碼
                    </h4>
                </div>
                <div class="card-body p-4">

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            請檢查並修正下列錯誤：
                        </div>
                    }

                    <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- 目前密碼 -->
                        <div class="mb-3">
                            <label asp-for="CurrentPassword" class="form-label fw-semibold">
                                <i class="fas fa-lock me-1"></i>目前密碼
                            </label>
                            <div class="input-group">
                                <input asp-for="CurrentPassword" class="form-control" type="password" placeholder="請輸入目前的密碼" />
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('CurrentPassword')">
                                    <i class="fas fa-eye" id="CurrentPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger small"></span>
                        </div>

                        <!-- 新密碼 -->
                        <div class="mb-3">
                            <label asp-for="NewPassword" class="form-label fw-semibold">
                                <i class="fas fa-key me-1"></i>新密碼
                            </label>
                            <div class="input-group">
                                <input asp-for="NewPassword" class="form-control" type="password" placeholder="請輸入新密碼" />
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('NewPassword')">
                                    <i class="fas fa-eye" id="NewPassword-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    密碼長度至少 6 個字元
                                </small>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger small"></span>
                        </div>

                        <!-- 確認新密碼 -->
                        <div class="mb-4">
                            <label asp-for="ConfirmPassword" class="form-label fw-semibold">
                                <i class="fas fa-check-double me-1"></i>確認新密碼
                            </label>
                            <div class="input-group">
                                <input asp-for="ConfirmPassword" class="form-control" type="password" placeholder="請再次輸入新密碼" />
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('ConfirmPassword')">
                                    <i class="fas fa-eye" id="ConfirmPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <!-- 密碼強度指示器 -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">密碼強度</label>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="strengthText" class="form-text text-muted">請輸入密碼</small>
                        </div>

                        <!-- 安全提示 -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-shield-alt me-2"></i>安全提示</h6>
                            <ul class="mb-0 small">
                                <li>建議使用包含大小寫字母、數字和特殊字元的強密碼</li>
                                <li>不要使用容易猜測的個人資訊作為密碼</li>
                                <li>定期更換密碼以確保帳戶安全</li>
                            </ul>
                        </div>

                        <!-- 按鈕區域 -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning text-dark">
                                <span class="btn-text">
                                    <i class="fas fa-save me-2"></i>修改密碼
                                </span>
                                <span class="btn-loading d-none">
                                    <span class="spinner-border spinner-border-sm me-2"></span>修改中...
                                </span>
                            </button>

                            <a asp-action="Profile" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>返回個人資料
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 密碼要求說明 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list-check me-2"></i>密碼要求
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled small">
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>至少 6 個字元
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-check text-success me-2"></i>包含字母
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled small">
                                <li class="mb-1">
                                    <i class="fas fa-plus text-info me-2"></i>建議包含數字
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-plus text-info me-2"></i>建議包含特殊字元
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // 切換密碼顯示/隱藏
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');

            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // 密碼強度檢查
        document.getElementById('NewPassword').addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            let strength = 0;
            let strengthLabel = '';
            let strengthColor = '';

            if (password.length >= 6) strength += 25;
            if (password.match(/[a-z]/)) strength += 25;
            if (password.match(/[A-Z]/)) strength += 25;
            if (password.match(/[0-9]/)) strength += 12.5;
            if (password.match(/[^A-Za-z0-9]/)) strength += 12.5;

            if (strength === 0) {
                strengthLabel = '請輸入密碼';
                strengthColor = '';
            } else if (strength < 50) {
                strengthLabel = '弱';
                strengthColor = 'bg-danger';
            } else if (strength < 75) {
                strengthLabel = '中等';
                strengthColor = 'bg-warning';
            } else {
                strengthLabel = '強';
                strengthColor = 'bg-success';
            }

            strengthBar.style.width = strength + '%';
            strengthBar.className = 'progress-bar ' + strengthColor;
            strengthText.textContent = '密碼強度: ' + strengthLabel;
        });

        // 表單提交時的載入狀態
        document.getElementById('changePasswordForm').addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            submitBtn.disabled = true;
        });

        // 確認密碼即時驗證
        document.getElementById('ConfirmPassword').addEventListener('input', function(e) {
            const newPassword = document.getElementById('NewPassword').value;
            const confirmPassword = e.target.value;

            if (confirmPassword && newPassword !== confirmPassword) {
                e.target.classList.add('is-invalid');
                e.target.classList.remove('is-valid');
            } else if (confirmPassword) {
                e.target.classList.add('is-valid');
                e.target.classList.remove('is-invalid');
            } else {
                e.target.classList.remove('is-valid', 'is-invalid');
            }
        });
    </script>
}

<style>
    .input-group .btn {
        border-left: 0;
    }

    .progress-bar {
        transition: width 0.3s ease, background-color 0.3s ease;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
</style>